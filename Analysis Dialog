<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --navy-blue: #1B365D;
        --gold-yellow: #FFC72C;
        --purple-dark: #6B3FA0;
        --purple-light: #E8DEF8;
        --green-light: #C8E6C9;
        --red-light: #FFCDD2;
        --gray-dark: #616161;
        --gray-light: #F5F5F5;
        --blue-accent: #4285F4;
      }
      
      * { box-sizing: border-box; }
      
      body { 
        font-family: 'Roboto', sans-serif; 
        background-color: var(--gray-light); 
        padding: 20px; 
        margin: 0;
      }
      .container { max-width: 520px; margin: 0 auto; }
      
      h3 { 
        font-weight: 500; 
        color: var(--navy-blue); 
        margin-bottom: 16px; 
        border-bottom: 3px solid var(--gold-yellow);
        padding-bottom: 10px;
        font-size: 18px;
      }
      
      /* -- Section Headers -- */
      .section-header {
        font-weight: 500;
        font-size: 13px;
        color: var(--navy-blue);
        margin-top: 18px;
        margin-bottom: 8px;
        padding: 6px 12px;
        background-color: var(--purple-light);
        border-left: 4px solid var(--purple-dark);
        border-radius: 0 4px 4px 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      /* -- Form Controls -- */
      .form-group { margin-bottom: 4px; }
      
      label.field-label { 
        display: block; 
        font-weight: 500; 
        margin-bottom: 6px; 
        color: var(--navy-blue);
        font-size: 13px;
      }
      
      select, input[type="text"], input[type="url"] { 
        width: 100%; 
        padding: 10px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
        font-size: 14px;
        font-family: 'Roboto', sans-serif;
      }
      select:focus, input:focus { 
        outline: none; 
        border-color: var(--purple-dark); 
        box-shadow: 0 0 0 2px var(--purple-light);
      }
      
      /* -- Checkbox Group (Value Streams) -- */
      .checkbox-group {
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        overflow: hidden;
      }
      .select-all-bar {
        padding: 8px 12px;
        background: #f0edfa;
        border-bottom: 1px solid #ddd;
        font-size: 13px;
      }
      .select-all-bar label { cursor: pointer; font-weight: 500; color: var(--purple-dark); }
      .select-all-bar input[type="checkbox"] { 
        margin-right: 8px; width: 16px; height: 16px; accent-color: var(--purple-dark); vertical-align: middle;
      }
      
      .checkbox-list {
        max-height: 170px;
        overflow-y: auto;
        padding: 4px 0;
      }
      .checkbox-item {
        padding: 6px 12px;
        transition: background 0.15s;
      }
      .checkbox-item:hover { background: #f8f6fd; }
      .checkbox-item label { 
        cursor: pointer; display: flex; align-items: center; font-size: 14px; color: #333;
      }
      .checkbox-item input[type="checkbox"] { 
        margin-right: 10px; width: 16px; height: 16px; accent-color: var(--purple-dark); flex-shrink: 0;
      }
      .vs-count { 
        font-size: 11px; color: var(--gray-dark); margin-left: auto; font-style: italic; 
      }
      
      /* -- Radio Cards -- */
      .radio-cards { display: flex; flex-direction: column; gap: 6px; }
      .radio-card {
        display: flex; align-items: center;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
        background: white;
      }
      .radio-card:hover { background: #f8f6fd; border-color: var(--purple-dark); }
      .radio-card.selected { 
        background: var(--purple-light); 
        border-color: var(--purple-dark);
      }
      .radio-card input[type="radio"] { 
        margin-right: 10px; accent-color: var(--purple-dark); flex-shrink: 0;
      }
      .radio-card .card-content { flex: 1; }
      .radio-card .card-title { font-size: 14px; font-weight: 500; color: #333; }
      .radio-card .card-desc { font-size: 11px; color: var(--gray-dark); margin-top: 2px; }
      
      /* -- Collapsible Destination Section -- */
      .destination-section { margin-top: 4px; }
      .destination-toggle {
        display: flex; align-items: center; justify-content: space-between;
        padding: 6px 12px;
        background: var(--purple-light);
        border-left: 4px solid var(--purple-dark);
        border-radius: 0 4px 4px 0;
        cursor: pointer;
        user-select: none;
        margin-top: 18px;
        margin-bottom: 8px;
      }
      .destination-toggle .section-title {
        font-weight: 500; font-size: 13px; color: var(--navy-blue);
        text-transform: uppercase; letter-spacing: 0.5px;
      }
      .destination-toggle .chevron {
        font-size: 12px; color: var(--gray-dark); transition: transform 0.2s;
      }
      .destination-toggle .chevron.open { transform: rotate(180deg); }
      .destination-body { overflow: hidden; transition: max-height 0.25s ease; }
      .destination-body.collapsed { max-height: 0 !important; }
      
      /* -- Saved Reports Sub-section -- */
      .sub-section {
        margin-top: 10px;
        padding: 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .sub-section.hidden { display: none; }
      .sub-section label.field-label { margin-bottom: 4px; }
      .sub-section select { margin-top: 4px; }
      
      .save-option {
        margin-top: 10px;
        padding: 8px;
        background: var(--green-light);
        border-radius: 4px;
      }
      .save-option.hidden { display: none; }
      .save-option label { 
        display: flex; align-items: center; font-size: 13px; cursor: pointer;
      }
      .save-option input[type="checkbox"] { margin-right: 8px; }
      
      .label-input { margin-top: 8px; }
      .label-input.hidden { display: none; }
      .label-input input { margin-top: 4px; }
      
      .manage-link {
        display: inline-block; margin-top: 8px;
        font-size: 12px; color: var(--purple-dark);
        cursor: pointer; text-decoration: underline;
      }
      .manage-link:hover { color: var(--navy-blue); }
      
      .help-text { font-size: 11px; color: var(--gray-dark); margin-top: 4px; }
      
      /* -- Action Button -- */
      .action-bar {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 2px solid var(--gold-yellow);
      }
      
      button.primary-btn { 
        background-color: var(--navy-blue); 
        color: white; 
        padding: 14px 20px; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 16px; 
        width: 100%;
        font-weight: 500;
        font-family: 'Roboto', sans-serif;
        transition: background 0.15s;
      }
      button.primary-btn:hover { background-color: #152a4a; }
      button.primary-btn:disabled { background-color: #aaa; cursor: not-allowed; }
      
      button.secondary-btn {
        background: var(--gray-light); color: var(--gray-dark);
        border: 1px solid #ccc; padding: 8px 16px; border-radius: 4px;
        cursor: pointer; font-size: 13px; font-family: 'Roboto', sans-serif;
        width: 100%; margin-top: 8px;
      }
      button.secondary-btn:hover { background: #e0e0e0; }
      
      /* -- Status -- */
      #status { 
        margin-top: 12px; 
        color: var(--gray-dark); 
        text-align: center; 
        padding: 10px;
        border-radius: 4px;
        font-size: 13px;
      }
      #status:empty { display: none; }
      #status.error { background: var(--red-light); color: #c62828; }
      #status.success { background: var(--green-light); color: #2e7d32; }
      #status.processing { background: #e3f2fd; color: var(--blue-accent); }
      
      .open-report-btn {
        display: inline-block;
        padding: 10px 20px;
        background: var(--purple-dark);
        color: white !important;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        transition: background 0.2s;
      }
      .open-report-btn:hover {
        background: var(--navy-blue);
      }
      
      /* -- Modal -- */
      .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
      }
      .modal-overlay.show { display: flex; align-items: center; justify-content: center; }
      .modal-content {
        background: white; padding: 20px; border-radius: 8px;
        max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;
      }
      .modal-header {
        font-size: 16px; font-weight: 500; color: var(--navy-blue);
        margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--gold-yellow);
      }
      .saved-report-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;
      }
      .saved-report-item .report-label { font-size: 13px; }
      .saved-report-item .report-date { font-size: 11px; color: var(--gray-dark); }
      .no-saved-reports { color: var(--gray-dark); font-style: italic; text-align: center; padding: 20px; }
      .btn-danger { 
        background: #C62828; color: white; border: none; padding: 6px 12px; 
        border-radius: 4px; cursor: pointer; font-size: 12px;
      }
      .btn-danger:hover { background: #a31f1f; }
    </style>
  </head>
  <body>
    <div class="container">
      <h3>Analyze Program Increment</h3>
      
      <!-- ============================================ -->
      <!-- PI Number                                   -->
      <!-- ============================================ -->
      <div class="section-header">PI Selection</div>
      <div class="form-group">
        <select id="piNumber" onchange="onPIChange()">
          <option value="">-- Select PI --</option>
          <option value="13">PI 13</option>
          <option value="14">PI 14</option>
          <option value="15">PI 15</option>
          <option value="16">PI 16</option>
          <option value="17">PI 17</option>
          <option value="18">PI 18</option>
          <option value="19">PI 19</option>
          <option value="20">PI 20</option>
        </select>
      </div>
      
      <!-- ============================================ -->
      <!-- Value Streams (multi-select)                -->
      <!-- ============================================ -->
      <div class="section-header">Value Streams</div>
      <div class="checkbox-group">
        <div class="select-all-bar">
          <label>
            <input type="checkbox" id="selectAllVS" onchange="toggleAllVS(this)">
            Select All Value Streams
          </label>
        </div>
        <div class="checkbox-list" id="vsCheckboxList">
          <div class="checkbox-item">
            <label><input type="checkbox" class="vs-checkbox" value="Patient Collaboration"> Patient Collaboration</label>
          </div>
          <div class="checkbox-item">
            <label><input type="checkbox" class="vs-checkbox" value="EMA Clinical"> EMA Clinical</label>
          </div>
          <div class="checkbox-item">
            <label><input type="checkbox" class="vs-checkbox" value="EMA RAC"> EMA RAC</label>
          </div>
          <div class="checkbox-item">
            <label><input type="checkbox" class="vs-checkbox" value="MMPM"> MMPM</label>
          </div>
          <div class="checkbox-item">
            <label><input type="checkbox" class="vs-checkbox" value="RCM Genie"> RCM Genie</label>
          </div>
        </div>
      </div>
      
      <!-- ============================================ -->
      <!-- Summary Options                             -->
      <!-- ============================================ -->
      <div class="section-header">Summary Options</div>
      <div class="radio-cards">
        <label class="radio-card selected" id="summaryCard_with" onclick="selectSummaryOption('with')">
          <input type="radio" name="summaryOption" value="with" checked>
          <div class="card-content">
            <div class="card-title">Full Update (With Summaries)</div>
            <div class="card-desc">Fetches JIRA data and regenerates all summary sheets</div>
          </div>
        </label>
        <label class="radio-card" id="summaryCard_without" onclick="selectSummaryOption('without')">
          <input type="radio" name="summaryOption" value="without">
          <div class="card-content">
            <div class="card-title">Fast Update (Skip Summaries)</div>
            <div class="card-desc">Fetches JIRA data only - faster, no summary regeneration</div>
          </div>
        </label>
      </div>
      
      <!-- ============================================ -->
      <!-- Report Destination (collapsible)            -->
      <!-- ============================================ -->
      <div class="destination-section">
        <div class="destination-toggle" onclick="toggleDestinationSection()">
          <span class="section-title">Report Destination</span>
          <span class="chevron" id="destChevron">&#9660;</span>
        </div>
        <div class="destination-body collapsed" id="destBody">
          <div class="radio-cards">
            <label class="radio-card selected" id="destCard_existing" onclick="selectDestination('existing')">
              <input type="radio" name="reportDestination" value="existing" checked>
              <div class="card-content">
                <div class="card-title">Add to Current Spreadsheet</div>
              </div>
            </label>
            <label class="radio-card" id="destCard_new" onclick="selectDestination('new')">
              <input type="radio" name="reportDestination" value="new">
              <div class="card-content">
                <div class="card-title">Create New Report Spreadsheet</div>
              </div>
            </label>
            <label class="radio-card" id="destCard_update" onclick="selectDestination('update')">
              <input type="radio" name="reportDestination" value="update">
              <div class="card-content">
                <div class="card-title">Update Existing Report</div>
              </div>
            </label>
          </div>
          
          <!-- Saved Reports (shown when "Update Existing" selected) -->
          <div class="sub-section hidden" id="savedReportSection">
            <label class="field-label">Select Saved Report:</label>
            <select id="savedReportSelect" onchange="onSavedReportChange()">
              <option value="">Loading...</option>
            </select>
            <span class="manage-link" onclick="openManageModal()">Manage Saved Reports</span>
            
            <!-- New URL input -->
            <div class="sub-section hidden" id="urlInputSection" style="border: none; padding: 8px 0 0 0;">
              <label class="field-label">Report URL:</label>
              <input type="url" id="existingReportUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
              <div class="help-text">Paste the full URL of a previously generated report.</div>
              
              <div class="save-option" id="saveCheckboxContainer">
                <label>
                  <input type="checkbox" id="saveForFuture" checked onchange="toggleLabelInput()">
                  Save this report for future use
                </label>
              </div>
              
              <div class="label-input" id="labelInputContainer">
                <label class="field-label">Report Label:</label>
                <input type="text" id="reportLabel" placeholder="e.g., PI 15 - MMPM">
                <div class="help-text">Auto-filled from PI and Value Stream selection.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ============================================ -->
      <!-- Action Buttons                              -->
      <!-- ============================================ -->
      <div class="action-bar">
        <button class="primary-btn" id="runButton" onclick="runAnalysis()">
          Run Full Analysis
        </button>
        <button class="secondary-btn" onclick="google.script.host.close()">
          Cancel
        </button>
        <div id="status"></div>
      </div>
    </div>
    
    <!-- ============================================ -->
    <!-- Manage Saved Reports Modal                  -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="manageModal">
      <div class="modal-content">
        <div class="modal-header">Manage Saved Reports</div>
        <div id="savedReportsList"></div>
        <button class="secondary-btn" onclick="closeManageModal()" style="margin-top: 15px;">Close</button>
      </div>
    </div>
    
    <script>
      var savedReports = [];
      
      // -- Initialization --
      document.addEventListener('DOMContentLoaded', function() {
        loadSavedReports();
      });
      
      // -- PI Change Handler --
      function onPIChange() {
        updateAutoLabel();
        updateButtonLabel();
      }
      
      // -- Value Stream Select All --
      function toggleAllVS(checkbox) {
        document.querySelectorAll('.vs-checkbox').forEach(function(cb) {
          cb.checked = checkbox.checked;
        });
        updateAutoLabel();
        updateButtonLabel();
      }
      
      // Listen for individual VS checkbox changes
      document.querySelectorAll('.vs-checkbox').forEach(function(cb) {
        cb.addEventListener('change', function() {
          var allChecked = document.querySelectorAll('.vs-checkbox').length === 
                           document.querySelectorAll('.vs-checkbox:checked').length;
          document.getElementById('selectAllVS').checked = allChecked;
          updateAutoLabel();
          updateButtonLabel();
        });
      });
      
      // -- Summary Option Cards --
      function selectSummaryOption(option) {
        document.querySelectorAll('[id^="summaryCard_"]').forEach(function(card) {
          card.classList.remove('selected');
        });
        document.getElementById('summaryCard_' + option).classList.add('selected');
        document.querySelector('input[name="summaryOption"][value="' + option + '"]').checked = true;
        updateButtonLabel();
      }
      
      // -- Destination Section (collapsible) --
      function toggleDestinationSection() {
        var body = document.getElementById('destBody');
        var chevron = document.getElementById('destChevron');
        body.classList.toggle('collapsed');
        chevron.classList.toggle('open');
        
        if (!body.classList.contains('collapsed')) {
          body.style.maxHeight = body.scrollHeight + 300 + 'px';
        }
      }
      
      function selectDestination(dest) {
        document.querySelectorAll('[id^="destCard_"]').forEach(function(card) {
          card.classList.remove('selected');
        });
        document.getElementById('destCard_' + dest).classList.add('selected');
        document.querySelector('input[name="reportDestination"][value="' + dest + '"]').checked = true;
        
        var savedSection = document.getElementById('savedReportSection');
        if (dest === 'update') {
          savedSection.classList.remove('hidden');
          onSavedReportChange();
        } else {
          savedSection.classList.add('hidden');
          document.getElementById('urlInputSection').classList.add('hidden');
        }
        
        // Re-calc max-height
        var body = document.getElementById('destBody');
        if (!body.classList.contains('collapsed')) {
          setTimeout(function() { body.style.maxHeight = body.scrollHeight + 'px'; }, 50);
        }
        
        updateButtonLabel();
      }
      
      // -- Dynamic Button Label --
      function updateButtonLabel() {
        var btn = document.getElementById('runButton');
        var summaryOption = document.querySelector('input[name="summaryOption"]:checked').value;
        var dest = document.querySelector('input[name="reportDestination"]:checked').value;
        
        var label = 'Run ';
        label += (summaryOption === 'with') ? 'Full' : 'Fast';
        label += ' Analysis';
        
        if (dest === 'new') {
          label += ' \u2192 New Report';
        } else if (dest === 'update') {
          label += ' \u2192 Update Report';
        }
        
        btn.textContent = label;
      }
      
      // -- Saved Reports --
      function loadSavedReports() {
        google.script.run
          .withSuccessHandler(function(reports) {
            savedReports = reports || [];
            populateSavedReportsDropdown();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading saved reports:', error);
            savedReports = [];
            populateSavedReportsDropdown();
          })
          .getSavedReports();
      }
      
      function populateSavedReportsDropdown() {
        var select = document.getElementById('savedReportSelect');
        select.innerHTML = '';
        
        var newUrlOption = document.createElement('option');
        newUrlOption.value = '__new__';
        newUrlOption.textContent = '+ Enter new URL...';
        select.appendChild(newUrlOption);
        
        if (savedReports.length > 0) {
          var separator = document.createElement('option');
          separator.disabled = true;
          separator.textContent = '--------------------';
          select.appendChild(separator);
          
          savedReports.forEach(function(report) {
            var option = document.createElement('option');
            option.value = report.url;
            var dateStr = report.dateAdded ? new Date(report.dateAdded).toLocaleDateString() : '';
            option.textContent = report.label + (dateStr ? ' (' + dateStr + ')' : '');
            select.appendChild(option);
          });
        }
      }
      
      function onSavedReportChange() {
        var select = document.getElementById('savedReportSelect');
        var urlSection = document.getElementById('urlInputSection');
        var urlInput = document.getElementById('existingReportUrl');
        
        if (select.value === '__new__') {
          urlSection.classList.remove('hidden');
          document.getElementById('saveForFuture').checked = true;
          toggleLabelInput();
          urlInput.value = '';
          updateAutoLabel();
        } else if (select.value) {
          urlSection.classList.add('hidden');
          urlInput.value = select.value;
        } else {
          urlSection.classList.add('hidden');
        }
        
        // Re-calc max-height
        var body = document.getElementById('destBody');
        if (!body.classList.contains('collapsed')) {
          setTimeout(function() { body.style.maxHeight = body.scrollHeight + 'px'; }, 50);
        }
      }
      
      function toggleLabelInput() {
        var saveChecked = document.getElementById('saveForFuture').checked;
        var labelContainer = document.getElementById('labelInputContainer');
        if (saveChecked) {
          labelContainer.classList.remove('hidden');
          updateAutoLabel();
        } else {
          labelContainer.classList.add('hidden');
        }
      }
      
      function updateAutoLabel() {
        var piNumber = document.getElementById('piNumber').value;
        var selectedVS = Array.from(document.querySelectorAll('.vs-checkbox:checked')).map(function(cb) { return cb.value; });
        var labelInput = document.getElementById('reportLabel');
        
        var parts = [];
        if (piNumber) parts.push('PI ' + piNumber);
        if (selectedVS.length > 0 && selectedVS.length <= 3) {
          parts.push(selectedVS.join(', '));
        } else if (selectedVS.length > 3) {
          parts.push(selectedVS.length + ' Value Streams');
        }
        
        labelInput.value = parts.join(' - ');
      }
      
      // -- Manage Modal --
      function openManageModal() {
        var modal = document.getElementById('manageModal');
        var list = document.getElementById('savedReportsList');
        
        if (savedReports.length === 0) {
          list.innerHTML = '<div class="no-saved-reports">No saved reports yet.</div>';
        } else {
          list.innerHTML = savedReports.map(function(report) {
            var dateStr = report.dateAdded ? new Date(report.dateAdded).toLocaleDateString() : '';
            return '<div class="saved-report-item">' +
              '<div>' +
                '<div class="report-label">' + escapeHtml(report.label) + '</div>' +
                '<div class="report-date">' + dateStr + '</div>' +
              '</div>' +
              '<button class="btn-danger" onclick="deleteSavedReport(\'' + escapeHtml(report.url) + '\')">Delete</button>' +
            '</div>';
          }).join('');
        }
        
        modal.classList.add('show');
      }
      
      function closeManageModal() {
        document.getElementById('manageModal').classList.remove('show');
      }
      
      function deleteSavedReport(url) {
        if (!confirm('Delete this saved report?')) return;
        
        google.script.run
          .withSuccessHandler(function() {
            loadSavedReports();
            openManageModal();
          })
          .withFailureHandler(function(error) {
            alert('Error deleting report: ' + error.message);
          })
          .deleteSavedReport(url);
      }
      
      function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // =============================================
      // MAIN ACTION: Run Analysis
      // =============================================
      function runAnalysis() {
        var button = document.getElementById('runButton');
        var status = document.getElementById('status');
        
        // Reset status
        status.innerText = '';
        status.className = '';
        
        // -- Validate --
        var piNumber = document.getElementById('piNumber').value;
        if (!piNumber) {
          status.innerText = 'Please select a PI number.';
          status.className = 'error';
          return;
        }
        
        var selectedVS = Array.from(document.querySelectorAll('.vs-checkbox:checked')).map(function(cb) { return cb.value; });
        if (selectedVS.length === 0) {
          status.innerText = 'Please select at least one value stream.';
          status.className = 'error';
          return;
        }
        
        var summaryOption = document.querySelector('input[name="summaryOption"]:checked').value;
        var reportDestination = document.querySelector('input[name="reportDestination"]:checked').value;
        
        // Get URL based on selection
        var existingReportUrl = '';
        var saveForFuture = false;
        var reportLabel = '';
        
        if (reportDestination === 'update') {
          var savedReportSelect = document.getElementById('savedReportSelect');
          
          if (savedReportSelect.value === '__new__') {
            existingReportUrl = document.getElementById('existingReportUrl').value.trim();
            saveForFuture = document.getElementById('saveForFuture').checked;
            reportLabel = document.getElementById('reportLabel').value.trim();
          } else {
            existingReportUrl = savedReportSelect.value;
          }
          
          if (!existingReportUrl) {
            status.innerText = 'Please select a saved report or enter a URL.';
            status.className = 'error';
            return;
          }
          
          var urlPattern = /^https:\/\/docs\.google\.com\/spreadsheets\/d\/[a-zA-Z0-9_-]+/;
          if (!urlPattern.test(existingReportUrl)) {
            status.innerText = 'Invalid Google Sheets URL format.';
            status.className = 'error';
            return;
          }
          
          if (saveForFuture && !reportLabel) {
            status.innerText = 'Please enter a label for the saved report.';
            status.className = 'error';
            return;
          }
        }
        
        // -- Disable UI & show processing --
        button.disabled = true;
        status.innerHTML = '\u23F3 Running PI ' + piNumber + ' analysis for ' + selectedVS.join(', ') + '...';
        status.className = 'processing';
        
        // -- Save report if requested --
        if (saveForFuture && existingReportUrl && reportLabel) {
          google.script.run
            .withSuccessHandler(function() { loadSavedReports(); })
            .withFailureHandler(function(error) { console.error('Error saving report:', error); })
            .saveReport(reportLabel, existingReportUrl);
        }
        
        // -- Call backend --
        google.script.run
          .withSuccessHandler(function(result) {
            var parsed = null;
            try {
              parsed = JSON.parse(result);
            } catch (e) {
              // Not JSON, just a string message
            }
            
            if (parsed && parsed.reportUrl) {
              // Show success with clickable button
              var summaryInfo = '';
              if (parsed.summaryResults) {
                summaryInfo = '<br><small>Generated: ' + 
                  parsed.summaryResults.teamSummaries + ' team summaries, ' +
                  parsed.summaryResults.initiativeAnalysis + ' initiative tabs' +
                  (parsed.summaryResults.dansReport ? ", Dan's Report" : '') +
                  '</small>';
              }
              
              status.innerHTML = '\u2705 ' + (parsed.message ? parsed.message.split('\n')[0] : 'Report created!') +
                summaryInfo +
                '<br><br>' +
                '<a href="' + parsed.reportUrl + '" target="_blank" class="open-report-btn">\uD83D\uDCC2 Open Report</a>';
              status.className = 'success';
            } else {
              // Plain text result
              status.innerText = '\u2705 ' + (result || 'Analysis complete.');
              status.className = 'success';
            }
            button.disabled = false;
          })
          .withFailureHandler(function(err) {
            status.innerText = '\u274C Error: ' + err.message;
            status.className = 'error';
            button.disabled = false;
          })
          .runUnifiedAnalysis({
            piNumber: piNumber,
            valueStreams: selectedVS,
            summaryOption: summaryOption,
            reportDestination: reportDestination,
            existingReportUrl: existingReportUrl
          });
      }
    </script>
  </body>
</html>
